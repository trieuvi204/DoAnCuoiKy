<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>THANH TOÁN</title>
	<link rel="stylesheet" href="../../css/pay/pay.css">
	<link rel="icon" href="../../img/Logo/logo_tt.png" type="image/png" sizes="48x48">
	<link rel="icon" href="Resources/img/Logo/logo_tt.png" type="image/png" sizes="48x48">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<!-- icon -->
	<script src="https://kit.fontawesome.com/d5d4311ae6.js" crossorigin="anonymous"></script>

	<!-- Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inder&display=swap" rel="stylesheet">
	<!-- AOS Libary -->
	<link href="../../../Vendors/aos-master/dist/aos.css" rel="stylesheet">
	<script src="../../../Vendors/aos-master/dist/aos.js"></script>


	<!-- thư viện crypto-js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>


	<!-- sweet alert -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<style>
		/* set up */
		* {
			padding: 0px;
			margin: 0px;
			box-sizing: border-box;
		}

		/* Body */
		body {
			font-family: "Inder", sans-serif;
			font-weight: 400;
			font-style: normal;
		}
	</style>
</head>

<body id="pay-page" class="pay-page">
	<header id="header" class="header d-flex align-items-center fixed-top">
		<div class="container-fluid container-xl position-relative d-flex align-items-center">
			<div class="container">
				<div class="row">
					<div class="fixed_header">
						<div class="logo col-lg-2">
							<a href="../../../index.html" class="logo d-flex align-items-center me-auto ">
								<img src="../../img/Logo/logo_tt.png" alt="logo">
							</a>
						</div>
						<div class="navmenu col-lg-10">
							<div class="row">
								<nav id="navmenu">
									<ul>
										<li class="col-lg-2"><a href="../../../index.html#home"><span>Trang Chủ</span></a></li>
										<li class="col-lg-2"><a href="../../../index.html#about"><span>Về Chúng Tôi</span></a>
										</li>
										<li class="dropdown col-lg-2"><a href="../../../index.html#service"><span>Dịch
													Vụ</span></a>
											<ul>
												<li><a href="../service/field_list.html">Đặt Sân</a></li>
												<li><a href="../service/rent_pitch.html">Thuê Áo Pitch</a>
												</li>
												<li><a href="../service/food.html">Đồ Ăn \ Thức Uống</a>
												</li>
											</ul>
										</li>
										<li class="col-lg-2"><a href="../../../index.html#contact"><span>Liên Hệ</span></a></li>
										<li class="dropdown col-lg-2"><a href="#"><span>Tài Khoản</span></a>
											<ul>
												<li class="dropdown user">
													<div class="user-container">
														<div class="user-img">
															<img src="../../img/avata/con_meo.jpg" alt="avata">
														</div>
														<h3>Nguyễn Văn An</h3>
														<a class="title" href="../manage-account/account.html">Quản lý tài khoản</a>
														<a class="inf-account" href="../manage-account/account.html#basic-inf">Thông tin tài khoản</a>
														<a class="inf-account" href="../manage-account/account.html#list">Danh sách đặt sân</a>
														<a class="title" href="../membership-card/membership-card.html">Thẻ thành viên</a>
														<button><a href="../../../../index.html">Đăng Xuất</a></button>
													</div>
												</li>
											</ul>
										</li>
										<li class="col-lg-2">
											<a class="btn-getstarted" href="../../../index.html#about"><span>Bắt Đầu</span></a>
										</li>
									</ul>
								</nav>

							</div>
						</div>

					</div>
				</div>
			</div>

		</div>
	</header>
	<div class="container">
		<div class="pay">
			<div class="row row-cols-3">
				<div class="row">
					<div class="title-pay title" data-aos="fade-up">
						<h2 data-aos="fade-up"> THANH TOÁN</h2>
					</div>
				</div>
				<div class="row" data-aos="fade-up" data-aos-delay="100">
					<div class="user-inf"></div>

				</div>
				<div class="row" data-aos="fade-up" data-aos-delay="100">
					<div class="products">
						<div class="row row-cols-5">
							<div class="row service-inf" data-aos="fade-up" data-aos-delay="200">
								<div class="row row-cols-2">
									<div class="row field">
										<div class="col-lg-6 "><img class="field-img"
												src="" alt="san1"></div>
										<div class="col-lg-6 ">
											<div class="title" id="title"></div>
											<div class="inf">
												<p>Khung Giờ: <span class="khung_gio"></span></p>
												<p>Giá Sân: <span class="gia_san"></span></p>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="row" data-aos="fade-up" data-aos-delay="200">
								<div class="payment">
									<div class="row">
										<div class="col-lg-6">
											<div class="payment-method">
												<div class="text">
													<p><i class="fa-solid fa-money-check-dollar"></i></i> Phương thức
														thanh toán</p>
												</div>
												<div class="select_method">
													<select name="payment-method" id="payment-method">
														<option value="bank card">Thẻ Ngân Hàng</option>
														<option value="direct payment">Thanh Toán Tại Sân</option>
													</select>
												</div>
											</div>
										</div>
										<div class="col-lg-6">
											<div class="payment-limit">
												<div class="text">
													<p><i class="fa-solid fa-money-check-dollar"></i> Hạn mức thanh toán
													</p>
												</div>
												<div class="select_method">
													<select name="payment-limit" id="payment-limit" disabled>
														<option value="100%">Thanh toán 100%</option>
														<option value="30%">Cọc 30% sân</option>
													</select>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="row" data-aos="fade-up" data-aos-delay="200">
								<div class="payment-details">
									<div class="tittle">
										<p><i class="fa-solid fa-file-invoice-dollar"></i>Chi tiết thanh toán</p>
									</div>
									<div class="details">
										<div class="row">
											<div>
												<p class="title-service">Tổng tiền sân</p>
												<p class="title-price"></p>
											</div>
										</div>
										<div class="row">
											<div>
												<p class="total-title">Tổng thanh toán</p>
												<p class="total-price"></p>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="pay-btn">
									<div class="row">
										<div class="col-lg-8">
											<p class="total-pay">Tổng thanh toán</p>
											<p class="total-pay-price"></p>
										</div>
										<div class="col-lg-4">
											<button id="pay_btn">Thanh Toán</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	AOS.init();
</script>


<script>

var payment_limit_total = 0 

  // Lấy thông tin từ sessionStorage
  let ten_kh = sessionStorage.getItem("ten_kh");
  let sdt_kh = decryptDES( sessionStorage.getItem("sdt_kh"), "Thats my Kung Fu");
  let email_kh = sessionStorage.getItem("email_kh");
	let ten_san = sessionStorage.getItem("ten_san");
	let khung_gio = sessionStorage.getItem("khung gio");
	let gia_san = sessionStorage.getItem("gia");
	let ma_san = sessionStorage.getItem("ma_san");

// Hiển thị thông tin vào div
document.querySelector(".user-inf").innerHTML = `${ten_kh} | ${sdt_kh} | ${email_kh}`;
document.querySelector("#title").innerHTML = ten_san;
document.querySelector(".khung_gio").innerHTML = `${khung_gio}`;
document.querySelector(".gia_san").innerHTML = `${gia_san}`;
document.querySelector(".title-price").innerHTML = `${gia_san}đ`;
document.querySelector(".total-pay-price").innerHTML = `${gia_san}đ`;


let imgElement = document.querySelector(".field-img");
imgElement.src = `../../img/field_list/${ma_san}.jpg`

document.addEventListener('DOMContentLoaded', function() {
	var payment_method = document.querySelector('#payment-method');
	var payment_limit = document.querySelector('#payment-limit');

	payment_method.addEventListener('change', function() {
			if(payment_method.value === "direct payment") {
					payment_limit.selectedIndex = 1;
					payment_limit_total = 30/100;
			}
			if(payment_method.value === "bank card") {
					payment_limit.selectedIndex = 0;
					payment_limit_total = 1;

			}
			document.querySelector(".total-price").innerHTML = `${gia_san * payment_limit_total}đ`;
			document.querySelector(".total-pay-price").innerHTML = `${gia_san * payment_limit_total}đ`;
	});
});

const urlCreateBill ='http://localhost:8000/bill/module/v1/bill/create'
const url_orderItems = 'http://localhost:8000/order-items/module/v1/order-items/create';

var pay_btn = document.getElementById('pay_btn');

if (pay_btn) { // Kiểm tra pay_btn tồn tại
  pay_btn.addEventListener('click', function(e) {
		e.preventDefault();
		var total = document.querySelector(".total-pay-price").innerHTML 
		sessionStorage.setItem('total-pay-price', total);

    var payment_limit = document.querySelector('#payment-limit');

    if (payment_limit && !payment_limit.value) { // Kiểm tra payment_limit tồn tại và không có giá trị
      Swal.fire({
        icon: 'error',
        title: 'Chưa chọn phương thức thanh toán',
        text: `Bạn hãy chọn một phương thức thanh toán`,
      });
    }
		else{
			const ma_pds = sessionStorage.getItem('ma_pds');
			const date = sessionStorage.getItem('NGAY_DAT_SAN');
			const start = sessionStorage.getItem('GIO_BAT_DAU');
			const end = sessionStorage.getItem('GIO_KET_THUC');
			const ghi_chu = sessionStorage.getItem('GHI_CHU');

			createOrderItems(ma_pds, date, start, end, ghi_chu, total);
		}
  });
} else {
  console.error('Phần tử với ID "pay_btn" không tồn tại.');
}

function createOrderItems(ma_pds, date, start, end, ghi_chu, total) {		
	const fixedEnd = end.length === 5 ? end + ":00" : end; // Thêm ":00" nếu thiếu phần giây

	// Kết hợp ngày và giờ bắt đầu, giờ kết thúc
	const dateObj = new Date(date);
if (isNaN(dateObj.getTime())) {
    throw new Error("Ngày không hợp lệ");
}

const gioBd = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), start.split(':')[0], start.split(':')[1]));
const gioKt = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), fixedEnd.split(':')[0], fixedEnd.split(':')[1]));


	
	sessionStorage.setItem("ngay_dat_san", dateObj)
	// Chuyển đổi thành chuỗi ISO string
	const orderItemsData = {
		ma_san: sessionStorage.getItem("ma_san"), // Giả sử ma_san là string
		ma_pds: ma_pds, // Giả sử ma_pds là string
		ngay_dat_san: dateObj.toISOString(),  // Chuyển đổi ngày thành chuỗi ISO string
		gio_bd: gioBd.toISOString(),  // Chuyển đổi giờ bắt đầu thành chuỗi ISO string
		gio_kt: gioKt.toISOString(),  // Chuyển đổi giờ kết thúc thành chuỗi ISO string
		ghi_chu: ghi_chu  // Lấy ghi chú từ input (giả sử là chuỗi)
	};
	
	
	var option = {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify(orderItemsData)
	};

	fetch(url_orderItems, option)
	.then(function (response) {
		if (!response.ok) {
			return response.json().then(errorData => {
				throw new Error(errorData.detail || 'Lỗi khi tạo chi tiết phiếu đặt sân');
			});
		}
		return response.json();
	})
	.then(function(response){

		var hinh_thuc_thanh_toan = document.querySelector('#payment-method')
		console.log("🚀 ~ .then ~ hinh_thuc_thanh_toan:", hinh_thuc_thanh_toan.value)
		var han_muc_thanh_toan = document.querySelector('#payment-limit');
		console.log("🚀 ~ .then ~ han_muc_thanh_toan:", han_muc_thanh_toan.value)

		total = total.replace(/đ$/, ''); // Loại bỏ ký tự 'đ' ở cuối chuỗi
		total = parseInt(total, 10);
		console.log("🚀 ~ .then ~ total:", total)
		
		createBill(ma_pds, total, hinh_thuc_thanh_toan.value, han_muc_thanh_toan.value)
		window.location.href = '../bill/bill.html'
	})
	.catch(function (error) {
		Swal.fire({
			icon: "error",
			text: "Lỗi khi tạo chi tiết phiếu đặt sân: " + error.message,
		});
	});
}

function createBill(ma_pds, tong_tien_hd, hinh_thuc_thanh_toan, han_muc_thanh_toan) {

	const billData = {
		ma_pds : ma_pds,
		tong_tien_hd: tong_tien_hd,
		hinh_thuc_thanh_toan: hinh_thuc_thanh_toan,
		han_muc_thanh_toan: han_muc_thanh_toan
	}
	console.log("🚀 ~ createBill ~ billData:", billData)

	var option = {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify(billData)
	};

	fetch(urlCreateBill, option)
	.then(function (response) {
		if (!response.ok) {
			return response.json().then(errorData => {
				throw new Error(errorData.detail || 'Lỗi khi tạo hóa đơn');
			});
		}
		return response.json();
	})
	.catch(function (error) {
		Swal.fire({
			icon: "error",
			text: "Lỗi khi tạo hóa đơn: " + error.message,
		});
	});
}



	// Hàm tìm nghịch đảo modulo
function findMultInverse(a, m) {
	let t1 = 0, t2 = 1, r1 = m, r2 = a, q, t, r;

	while (r2 > 0) {
		q = Math.floor(r1 / r2);
		r = r1 - q * r2;
		r1 = r2;
		r2 = r;

		t = t1 - q * t2;
		t1 = t2;
		t2 = t;
	}

	if (t1 < 0) {
		t1 += m;
	}

	return t1;
}

// Hàm giải mã ký tự theo Caesar Multiplicative
function divideChar(c, key, modulus) {
	let ascii_val = c.charCodeAt(0);
	let new_val;

	if (ascii_val >= 32 && ascii_val <= 126) {
		new_val = ((ascii_val - 32) * key) % modulus + 32;
		return String.fromCharCode(new_val);
	} else {
		return c;
	}
}

// Hàm giải mã toàn bộ chuỗi
function decryptCaesarMult(enc, k) {
	const modulus = 95; // ASCII 32-126, phạm vi 95 ký tự có thể in được
	let k_inverse = findMultInverse(k, modulus); // Tìm nghịch đảo của key
	let decrypted = '';

	for (let i = 0; i < enc.length; i++) {
		decrypted += divideChar(enc[i], k_inverse, modulus);
	}

	return decrypted;
}

// Hàm giải mã DES
function decryptDES(encryptedHex, key) {
	// Chuyển đổi chuỗi hex thành byte array
	var encryptedBytes = CryptoJS.enc.Hex.parse(encryptedHex);

	// Chuyển khóa sang dạng byte array
	var keyBytes = CryptoJS.enc.Utf8.parse(key);

	// IV - sử dụng cùng giá trị với mã C# của bạn
	var iv = CryptoJS.enc.Hex.parse('0000000000000000'); // Đặt IV thành 0x0 cho mỗi byte

	// Giải mã DES với chế độ CBC và padding PKCS7
	var decrypted = CryptoJS.DES.decrypt(
		{
			ciphertext: encryptedBytes
		},
		keyBytes,
		{
			mode: CryptoJS.mode.CBC,
			padding: CryptoJS.pad.Pkcs7,
			iv: iv
		}
	);

	// Chuyển đổi kết quả giải mã sang chuỗi UTF-8
	return decrypted.toString(CryptoJS.enc.Utf8);
}


</script>
</html>