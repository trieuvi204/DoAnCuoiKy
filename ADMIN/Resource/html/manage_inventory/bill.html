<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>THANH TO√ÅN</title>
	<link rel="stylesheet" href="../../../../DoAnCuoiKy - user/Resources/css/pay/pay.css">
	<link rel="icon" href="../../img/Logo/logo_tt.png" type="image/png" sizes="48x48">
	<link rel="icon" href="Resources/img/Logo/logo_tt.png" type="image/png" sizes="48x48">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<!-- icon -->
	<script src="https://kit.fontawesome.com/d5d4311ae6.js" crossorigin="anonymous"></script>

	<!-- Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inder&display=swap" rel="stylesheet">
	<!-- AOS Libary -->
	<link href="../../../../Vendors/aos-master/dist/aos.css" rel="stylesheet">
	<script src="../../../../Vendors/aos-master/dist/aos.js"></script>


	<!-- th∆∞ vi·ªán crypto-js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>


	<!-- sweet alert -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<style>
		/* set up */
		* {
			padding: 0px;
			margin: 0px;
			box-sizing: border-box;
		}

		/* Body */
		body {
			font-family: "Inder", sans-serif;
			font-weight: 400;
			font-style: normal;
		}
	</style>
</head>

<body id="pay-page" class="pay-page">

	<div class="container">
		<div class="pay">
			<div class="row row-cols-3">
				<div class="row">
					<div class="title-pay title" data-aos="fade-up">
						<h2 data-aos="fade-up">H√ìA ƒê∆†N</h2>
					</div>
				</div>
				<div class="row" data-aos="fade-up" data-aos-delay="100">
					<div class="products">
						<div class="row row-cols-5">
							<div class="row service-inf" data-aos="fade-up" data-aos-delay="200">
								<div class="row row-cols-2">
									<div class="row items">
										
									</div>
								</div>
							</div>
							<div class="row">
								<div class="payment-details">
									<div class="tittle">
										<p><i class="fa-solid fa-file-invoice-dollar"></i>Chi ti·∫øt thanh to√°n</p>
									</div>
									<div class="details">
										<div class="row priceItemsList">
											<p class="title-service">Aquarius</p>
											<p class="title-price">1 x 137.000</p>
										</div>
										<div class="row">
											<div>
												<p class="total-title">T·ªïng thanh to√°n</p>
												<p class="total-price"></p>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="pay-btn">
									<div class="row">
										<div class="col-lg-8">
											<p class="total-pay">T·ªïng thanh to√°n</p>
											<p class="total-pay-price"></p>
										</div>
										<div class="col-lg-4">
											<a href="inventory_drinks_management.html"><button id="step_back">Quay L·∫°i</button></a>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	AOS.init();
</script>


<script>


function displayItems() {
  const data = JSON.parse(sessionStorage.getItem('cart')); // Chuy·ªÉn chu·ªói JSON th√†nh m·∫£ng
  const itemsContainer = document.querySelector(".row.items"); // L·∫•y ph·∫ßn t·ª≠ container ƒë·ªÉ hi·ªÉn th·ªã c√°c m·ª•c s·∫£n ph·∫©m
  const priceItemsList = document.querySelector(".priceItemsList"); // L·∫•y ph·∫ßn t·ª≠ ƒë·ªÉ hi·ªÉn th·ªã th√¥ng tin thanh to√°n
  const totalPriceElement = document.querySelector(".total-price"); // L·∫•y ph·∫ßn t·ª≠ ƒë·ªÉ hi·ªÉn th·ªã t·ªïng gi√°
  const totalPayPriceElement = document.querySelector(".total-pay-price"); // L·∫•y ph·∫ßn t·ª≠ ƒë·ªÉ hi·ªÉn th·ªã t·ªïng gi√° tr·ªã thanh to√°n
	var ma_mh = ''
	var so_luong = ''
  if (Array.isArray(data)) {
    itemsContainer.innerHTML = ''; // X√≥a n·ªôi dung c≈© trong container n·∫øu c·∫ßn
    priceItemsList.innerHTML = ''; // X√≥a n·ªôi dung c≈© trong danh s√°ch gi√°

    let totalPrice = 0; // Kh·ªüi t·∫°o bi·∫øn t·ªïng ti·ªÅn

    data.forEach((item) => {
      // Gi·ªØ nguy√™n gi√° tr·ªã g·ªëc c·ªßa item.price ƒë·ªÉ hi·ªÉn th·ªã
      const priceStr = item.price; // Gi√° tr·ªã g·ªëc d∆∞·ªõi d·∫°ng chu·ªói
      const price = Number(priceStr.replace(/[^0-9]+/g, '')); // Lo·∫°i b·ªè k√Ω t·ª± kh√¥ng ph·∫£i s·ªë ƒë·ªÉ t√≠nh to√°n
      const quantity = parseInt(item.quantity, 10); // Chuy·ªÉn ƒë·ªïi chu·ªói sang s·ªë nguy√™n
			so_luong = quantity;
			ma_mh = item.ma_mh

      // T·∫°o ph·∫ßn t·ª≠ HTML cho m·ªói m·ª•c
      const itemDiv = document.createElement('div');
      itemDiv.classList.add('item'); // Th√™m l·ªõp CSS cho m·ªói m·ª•c

      // Th√™m th√¥ng tin s·∫£n ph·∫©m v√†o ph·∫ßn t·ª≠ itemsContainer
      itemDiv.innerHTML = `
        <div class="row">
          <div class="col-lg-6">
            <img class="img" src="${item.imgSrc}" alt="${item.name}">
          </div>
          <div class="col-lg-6">
            <div class="titleItem" id="title">${item.name}</div>
            <div class="inf">
              <p>Gi√° Nh·∫≠p: <span class="gia">${priceStr}</span></p>
              <p>S·ªë L∆∞·ª£ng: <span class="soluong">${item.quantity}</span></p>
            </div>
          </div>
        </div>
      `;

      // Th√™m ph·∫ßn t·ª≠ itemDiv v√†o container
      itemsContainer.appendChild(itemDiv);

      // T·∫°o ph·∫ßn t·ª≠ th√¥ng tin thanh to√°n cho m·ªói m·ª•c v√† th√™m v√†o priceItemsList
      const priceItemDiv = document.createElement('div');
      priceItemDiv.classList.add('row');
      priceItemDiv.innerHTML = `
        <div class="col-6">
          <p class="title-service">${item.name}</p>
        </div>
        <div class="col-6">
          <p class="title-price">${item.quantity} x ${priceStr}</p>
        </div>
      `;

      // Th√™m ph·∫ßn t·ª≠ priceItemDiv v√†o danh s√°ch gi√°
      priceItemsList.appendChild(priceItemDiv);

      // T√≠nh t·ªïng ti·ªÅn (s·ª≠ d·ª•ng gi√° tr·ªã s·ªë ƒë·ªÉ t√≠nh to√°n)
      if (!isNaN(price) && !isNaN(quantity)) {
        totalPrice += price * quantity;
      }
    });

    // C·∫≠p nh·∫≠t ph·∫ßn t·ª≠ t·ªïng thanh to√°n
    if (totalPriceElement) {
      totalPriceElement.textContent = totalPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }

    // C·∫≠p nh·∫≠t ph·∫ßn t·ª≠ hi·ªÉn th·ªã t·ªïng gi√° tr·ªã thanh to√°n
    if (totalPayPriceElement) {
      totalPayPriceElement.textContent = totalPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }


// fetch
const url_orders_comodities = 'http://localhost:8000/order_commodity/module/v1/order_commodity/create';

		const pay_btn = document.getElementById('pay_btn');
		pay_btn.addEventListener('click', (e) => {
			e.preventDefault();
			handleCreatePN();
		});


	
	function handleCreatePN() {
		
			// L·∫•y gi√° tr·ªã t·ª´ c√°c input
			
			const ma_nv = sessionStorage.getItem("ma_nv");
			var formDataStaff = {
				ma_nv: ma_nv, // ƒê·∫£m b·∫£o ma_nv l√† chu·ªói
				ten_pn: 'Phi·∫øu Nh·∫≠p', // Gi·ªØ nguy√™n chu·ªói
				tong_tien_pn: totalPrice // Gi·ªØ nguy√™n gi√° tr·ªã l√† s·ªë
			};
			
      createPN(formDataStaff);
  }
	
	function createPN (data) {
		var option = {
			method: 'POST',
			headers: {
				'content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		};
	
	
		fetch(url_orders_comodities, option)
		.then(function (response) {
			// Ki·ªÉm tra xem response c√≥ th√†nh c√¥ng (status 200) kh√¥ng
			if (!response.ok) {
				return response.json().then(errorData => {
					// Tr·∫£ v·ªÅ l·ªói chi ti·∫øt n·∫øu c√≥
					throw new Error(errorData.detail || 'L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß');
				});
			}
			return response.json(); // L·∫•y d·ªØ li·ªáu JSON t·ª´ response n·∫øu th√†nh c√¥ng
		})
		.then(function (response) {
			const ma_pn = response.ma_pn; // L·∫•y m√£ phi·∫øu ƒë·∫∑t s√¢n t·ª´ response

			var data = sessionStorage.getItem('cart');

			// Chuy·ªÉn ƒë·ªïi chu·ªói JSON th√†nh m·∫£ng
			try {
					data = JSON.parse(data);

					// Ki·ªÉm tra n·∫øu data l√† m·∫£ng
					if (Array.isArray(data)) {
						// L·∫∑p qua to√†n b·ªô m·∫£ng data
						data.forEach(item => {
							const ma_mh = item.ma_mh; // L·∫•y m√£ m·∫∑t h√†ng
							const so_luong = item.quantity; // L·∫•y s·ªë l∆∞·ª£ng

							// G·ªçi h√†m cho t·ª´ng object trong data
							create_orders_comodities_detail(ma_pn, ma_mh, so_luong);
							});
					} else {
							console.error("üö® ~ D·ªØ li·ªáu kh√¥ng ph·∫£i l√† m·∫£ng:", data);
					}
			} catch (error) {
						console.error("üö® ~ L·ªói khi ph√¢n t√≠ch JSON:", error);
			}
		})

		.catch(function (error) {
			// Hi·ªÉn th·ªã l·ªói cho ng∆∞·ªùi d√πng
			Swal.fire({
				icon: "error",
				text: "Registration failed	. Error: " + error.message,
			});
		});
	}
	

// fetch


  } else {
    console.log("No data found or data is not an array");
  }
}


function create_orders_comodities_detail(ma_pn, ma_mh, so_luong) {		

	const url_orders_comodities_detail = 'http://localhost:8000/order_commodity_detail/module/v1/order_commodity_detail/create';

	// Chuy·ªÉn ƒë·ªïi th√†nh chu·ªói ISO string
	const orderItemsData = {
		ma_pn: ma_pn,
		ma_mh: ma_mh, // Gi·∫£ s·ª≠ ma_pds l√† string
		so_luong: so_luong 
	};


	var option = {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify(orderItemsData)
	};

	fetch(url_orders_comodities_detail, option)
		.then(function (response) {
			if (!response.ok) {
				return response.json().then(errorData => {
					throw new Error(errorData.detail || 'L·ªói khi t·∫°o chi ti·∫øt phi·∫øu nh·∫≠p');
				});
			}
			return response.json();
		})
		.catch(function (error) {
			Swal.fire({
				icon: "error",
				text: "L·ªói khi t·∫°o chi ti·∫øt phi·∫øu nh·∫≠p: " + error.message,
			});
		});
}






displayItems();

var payment_limit_total = 0 




// let imgElement = document.querySelector(".field-img");
// imgElement.src = `../../img/field_list/${ma_san}.jpg`

// document.addEventListener('DOMContentLoaded', function() {
// 	var payment_method = document.querySelector('#payment-method');
// 	var payment_limit = document.querySelector('#payment-limit');

// 	payment_method.addEventListener('change', function() {
// 			if(payment_method.value === "Thanh To√°n T·∫°i S√¢n") {
// 					payment_limit.selectedIndex = 1;
// 					payment_limit_total = 30/100;
// 			}
// 			if(payment_method.value === "Th·∫ª Ng√¢n H√†ng") {
// 					payment_limit.selectedIndex = 0;
// 					payment_limit_total = 1;

// 			}
// 			document.querySelector(".total-price").innerHTML = `${gia_san * payment_limit_total}ƒë`;
// 			document.querySelector(".total-pay-price").innerHTML = `${gia_san * payment_limit_total}ƒë`;
// 	});
// });


var pay_btn = document.getElementById('pay_btn');

if (pay_btn) { // Ki·ªÉm tra pay_btn t·ªìn t·∫°i
  pay_btn.addEventListener('click', function(e) {
		e.preventDefault();
		var total = document.querySelector(".total-pay-price").innerHTML 
	sessionStorage.setItem('total-pay-price', total);


  });
} else {
  console.error('Ph·∫ßn t·ª≠ v·ªõi ID "pay_btn" kh√¥ng t·ªìn t·∫°i.');
}







// 	// H√†m t√¨m ngh·ªãch ƒë·∫£o modulo
// function findMultInverse(a, m) {
// 	let t1 = 0, t2 = 1, r1 = m, r2 = a, q, t, r;

// 	while (r2 > 0) {
// 		q = Math.floor(r1 / r2);
// 		r = r1 - q * r2;
// 		r1 = r2;
// 		r2 = r;

// 		t = t1 - q * t2;
// 		t1 = t2;
// 		t2 = t;
// 	}

// 	if (t1 < 0) {
// 		t1 += m;
// 	}

// 	return t1;
// }

// // H√†m gi·∫£i m√£ k√Ω t·ª± theo Caesar Multiplicative
// function divideChar(c, key, modulus) {
// 	let ascii_val = c.charCodeAt(0);
// 	let new_val;

// 	if (ascii_val >= 32 && ascii_val <= 126) {
// 		new_val = ((ascii_val - 32) * key) % modulus + 32;
// 		return String.fromCharCode(new_val);
// 	} else {
// 		return c;
// 	}
// }

// // H√†m gi·∫£i m√£ to√†n b·ªô chu·ªói
// function decryptCaesarMult(enc, k) {
// 	const modulus = 95; // ASCII 32-126, ph·∫°m vi 95 k√Ω t·ª± c√≥ th·ªÉ in ƒë∆∞·ª£c
// 	let k_inverse = findMultInverse(k, modulus); // T√¨m ngh·ªãch ƒë·∫£o c·ªßa key
// 	let decrypted = '';

// 	for (let i = 0; i < enc.length; i++) {
// 		decrypted += divideChar(enc[i], k_inverse, modulus);
// 	}

// 	return decrypted;
// }

// // H√†m gi·∫£i m√£ DES
// function decryptDES(encryptedHex, key) {
// 	// Chuy·ªÉn ƒë·ªïi chu·ªói hex th√†nh byte array
// 	var encryptedBytes = CryptoJS.enc.Hex.parse(encryptedHex);

// 	// Chuy·ªÉn kh√≥a sang d·∫°ng byte array
// 	var keyBytes = CryptoJS.enc.Utf8.parse(key);

// 	// IV - s·ª≠ d·ª•ng c√πng gi√° tr·ªã v·ªõi m√£ C# c·ªßa b·∫°n
// 	var iv = CryptoJS.enc.Hex.parse('0000000000000000'); // ƒê·∫∑t IV th√†nh 0x0 cho m·ªói byte

// 	// Gi·∫£i m√£ DES v·ªõi ch·∫ø ƒë·ªô CBC v√† padding PKCS7
// 	var decrypted = CryptoJS.DES.decrypt(
// 		{
// 			ciphertext: encryptedBytes
// 		},
// 		keyBytes,
// 		{
// 			mode: CryptoJS.mode.CBC,
// 			padding: CryptoJS.pad.Pkcs7,
// 			iv: iv
// 		}
// 	);

// 	// Chuy·ªÉn ƒë·ªïi k·∫øt qu·∫£ gi·∫£i m√£ sang chu·ªói UTF-8
// 	return decrypted.toString(CryptoJS.enc.Utf8);
// }


</script>
</html>